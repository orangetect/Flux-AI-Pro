name: ğŸ”„ Upstream Sync

permissions:
  contents: write
  pull-requests: write

on:
  schedule:
    - cron: "0 5 * * *" # æ¯å¤© UTC æ—¶é—´ 05:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 13:00ï¼‰
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

env:
  UPSTREAM_REPO: kinai/Flux-AI-Pro
  UPSTREAM_BRANCH: main
  TARGET_BRANCH: main

jobs:
  sync-upstream:
    name: ğŸ”„ Sync Upstream Changes
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}
    
    steps:
      - name: ğŸ›ï¸ Checkout Target Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ env.TARGET_BRANCH }}

      - name: ğŸ› ï¸ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ“¡ Add Upstream Remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      - name: ğŸ”„ Merge Upstream Changes
        id: merge
        run: |
          # å°è¯•åˆå¹¶ä¸Šæ¸¸æ›´æ”¹
          if git merge --no-commit --no-ff upstream/${{ env.UPSTREAM_BRANCH }}; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "result=è‡ªåŠ¨åˆå¹¶æˆåŠŸ" >> $GITHUB_OUTPUT
          else
            # æ£€æµ‹æ˜¯å¦æœ‰å†²çª
            if git diff --check; then
              echo "status=conflict" >> $GITHUB_OUTPUT
              echo "result=å­˜åœ¨å†²çªéœ€è¦æ‰‹åŠ¨è§£å†³" >> $GITHUB_OUTPUT
            else
              echo "status=error" >> $GITHUB_OUTPUT
              echo "result=åˆå¹¶è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯" >> $GITHUB_OUTPUT
            fi
          fi

      - name: âœ… Push Changes
        if: steps.merge.outputs.status == 'success'
        run: |
          git commit -m "ğŸ”€ chore: auto-sync with upstream [${{ env.UPSTREAM_REPO }}@${{ env.UPSTREAM_BRANCH }}]"
          git push origin ${{ env.TARGET_BRANCH }}

      - name: âš ï¸ Create PR for Conflicts
        if: steps.merge.outputs.status == 'conflict'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ”€ chore: auto-sync with upstream (conflict resolution needed)"
          title: "ğŸ”€ Auto-Sync: Conflict Resolution Required"
          body: |
            ## âš ï¸ è‡ªåŠ¨åŒæ­¥æ£€æµ‹åˆ°å†²çª
            
            ä¸Šæ¸¸ä»“åº“ **${{ env.UPSTREAM_REPO }}** çš„æ›´æ”¹ä¸å½“å‰åˆ†æ”¯å­˜åœ¨å†²çªã€‚
            
            ### éœ€è¦æ‰‹åŠ¨å¤„ç†ï¼š
            - [ ] è§£å†³åˆå¹¶å†²çª
            - [ ] æµ‹è¯•åŠŸèƒ½æ˜¯å¦æ­£å¸¸
            - [ ] åˆå¹¶æ­¤ Pull Request
            
            ### ä¸Šæ¸¸ä»“åº“ä¿¡æ¯ï¼š
            - ä»“åº“ï¼š${{ env.UPSTREAM_REPO }}
            - åˆ†æ”¯ï¼š${{ env.UPSTREAM_BRANCH }}
            - åŒæ­¥æ—¶é—´ï¼š${{ github.event.schedule }}
            
            *æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
          branch: auto-sync/conflict-resolution
          base: ${{ env.TARGET_BRANCH }}

      - name: ğŸ“Š Sync Status Report
        run: |
          echo "=== åŒæ­¥çŠ¶æ€æŠ¥å‘Š ==="
          echo "ğŸ“… æ‰§è¡Œæ—¶é—´: $(date)"
          echo "ğŸ”„ åŒæ­¥çŠ¶æ€: ${{ steps.merge.outputs.status }}"
          echo "ğŸ“ åŒæ­¥ç»“æœ: ${{ steps.merge.outputs.result }}"
          echo "ğŸ“š ä¸Šæ¸¸ä»“åº“: ${{ env.UPSTREAM_REPO }}"
          echo "ğŸ¯ ç›®æ ‡åˆ†æ”¯: ${{ env.TARGET_BRANCH }}"
          
          if [ "${{ steps.merge.outputs.status }}" = "success" ]; then
            echo "âœ… åŒæ­¥æˆåŠŸï¼æ›´æ”¹å·²è‡ªåŠ¨æ¨é€ã€‚"
          elif [ "${{ steps.merge.outputs.status }}" = "conflict" ]; then
            echo "âš ï¸ æ£€æµ‹åˆ°å†²çªï¼å·²åˆ›å»º PR ç­‰å¾…æ‰‹åŠ¨è§£å†³ã€‚"
          else
            echo "âŒ åŒæ­¥å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—ã€‚"
          fi

  notify:
    name: ğŸ“¢ Notify Sync Result
    runs-on: ubuntu-latest
    needs: sync-upstream
    if: always()
    
    steps:
      - name: ğŸ“‹ Prepare Notification
        run: |
          echo "åŒæ­¥ä½œä¸šå·²å®Œæˆ"
          echo "ç»“æœ: ${{ needs.sync-upstream.result }}"
