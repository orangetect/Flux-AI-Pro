name: ğŸ”„ Sync with kinai9661/Flux-AI-Pro

permissions:
  contents: write

on:
  schedule:
    - cron: "0 5 * * *" # æ¯å¤© UTC æ—¶é—´ 05:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 13:00ï¼‰
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  UPSTREAM_REPO: kinai9661/Flux-AI-Pro
  UPSTREAM_BRANCH: main
  TARGET_BRANCH: main

jobs:
  sync-upstream:
    name: ğŸ”„ Sync from kinai9661/Flux-AI-Pro
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›ï¸ Checkout Current Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ› ï¸ Configure Git Identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ” Verify Upstream Access
        id: verify
        run: |
          echo "éªŒè¯ä¸Šæ¸¸ä»“åº“è®¿é—®: ${{ env.UPSTREAM_REPO }}"
          
          # æµ‹è¯•ä¸Šæ¸¸ä»“åº“æ˜¯å¦å¯ä»¥è®¿é—®
          if git ls-remote "https://github.com/${{ env.UPSTREAM_REPO }}.git" HEAD &>/dev/null; then
            echo "âœ… ä¸Šæ¸¸ä»“åº“å¯è®¿é—®: https://github.com/${{ env.UPSTREAM_REPO }}"
            echo "accessible=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ— æ³•è®¿é—®ä¸Šæ¸¸ä»“åº“"
            echo "accessible=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸ“¡ Setup Upstream Remote
        if: steps.verify.outputs.accessible == 'true'
        run: |
          # ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ä¸Šæ¸¸é…ç½®
          git remote remove upstream 2>/dev/null || true
          
          # æ·»åŠ ä¸Šæ¸¸ä»“åº“
          git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git"
          echo "âœ… å·²æ·»åŠ ä¸Šæ¸¸è¿œç¨‹: upstream -> https://github.com/${{ env.UPSTREAM_REPO }}.git"

      - name: ğŸ”„ Fetch Upstream Changes
        if: steps.verify.outputs.accessible == 'true'
        run: |
          echo "è·å–ä¸Šæ¸¸ä»“åº“çš„æ›´æ–°..."
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}
          
          echo "=== ä¸Šæ¸¸ä»“åº“æœ€æ–°æäº¤ ==="
          git log -1 --oneline upstream/${{ env.UPSTREAM_BRANCH }} || echo "æ— æ³•è·å–ä¸Šæ¸¸æäº¤"
          
          echo "=== å½“å‰ä»“åº“æœ€æ–°æäº¤ ==="
          git log -1 --oneline HEAD

      - name: ğŸ“Š Check for New Commits
        if: steps.verify.outputs.accessible == 'true'
        id: check
        run: |
          # æ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦æœ‰æ–°çš„æäº¤
          LOCAL_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})
          
          echo "æœ¬åœ°æäº¤: $LOCAL_COMMIT"
          echo "ä¸Šæ¸¸æäº¤: $UPSTREAM_COMMIT"
          
          if [ "$LOCAL_COMMIT" = "$UPSTREAM_COMMIT" ]; then
            echo "âœ… å·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€åŒæ­¥"
            echo "needs_sync=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ æ£€æµ‹åˆ°ä¸Šæ¸¸æœ‰æ–°æäº¤ï¼Œéœ€è¦åŒæ­¥"
            echo "needs_sync=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºå°†è¦åŒæ­¥çš„æäº¤
            echo "=== æ–°çš„æäº¤ ==="
            git log --oneline HEAD..upstream/${{ env.UPSTREAM_BRANCH }} || echo "æ— æ³•æ˜¾ç¤ºæäº¤å†å²"
          fi

      - name: ğŸ”€ Merge Upstream Changes
        if: steps.verify.outputs.accessible == 'true' && steps.check.outputs.needs_sync == 'true'
        id: merge
        run: |
          echo "å¼€å§‹åˆå¹¶ä¸Šæ¸¸æ›´æ”¹..."
          
          # ä½¿ç”¨ rebase æ–¹å¼åŒæ­¥ï¼Œé¿å…ç©ºçš„åˆå¹¶æäº¤
          if git rebase upstream/${{ env.UPSTREAM_BRANCH }}; then
            echo "âœ… Rebase æˆåŠŸ"
            echo "merge_status=success" >> $GITHUB_OUTPUT
          else
            # å¦‚æœ rebase å¤±è´¥ï¼Œå°è¯• merge
            git rebase --abort 2>/dev/null || true
            echo "å°è¯•ä½¿ç”¨ merge æ–¹å¼..."
            
            if git merge --no-commit --no-ff upstream/${{ env.UPSTREAM_BRANCH }}; then
              # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ›´æ”¹éœ€è¦æäº¤
              if git diff --quiet HEAD; then
                echo "âš ï¸ åˆå¹¶æˆåŠŸä½†æ²¡æœ‰å®é™…æ›´æ”¹"
                echo "merge_status=no_changes" >> $GITHUB_OUTPUT
                git reset --hard HEAD
              else
                echo "âœ… åˆå¹¶æˆåŠŸ"
                echo "merge_status=success" >> $GITHUB_OUTPUT
              fi
            else
              echo "âŒ åˆå¹¶å¤±è´¥ï¼Œå­˜åœ¨å†²çª"
              echo "merge_status=conflict" >> $GITHUB_OUTPUT
              git merge --abort 2>/dev/null || true
            fi
          fi

      - name: âœ… Push Changes
        if: steps.merge.outputs.merge_status == 'success'
        run: |
          echo "æ¨é€æ›´æ”¹åˆ°ä»“åº“..."
          git push origin ${{ env.TARGET_BRANCH }}
          echo "âœ… åŒæ­¥å®Œæˆï¼æ›´æ”¹å·²æ¨é€åˆ°ä»“åº“"

      - name: ğŸ“ Create Sync Commit
        if: steps.merge.outputs.merge_status == 'no_changes'
        run: |
          echo "åˆ›å»ºåŒæ­¥æ ‡è®°æäº¤..."
          # å³ä½¿æ²¡æœ‰æ–‡ä»¶æ›´æ”¹ï¼Œä¹Ÿåˆ›å»ºä¸€ä¸ªæ ‡è®°æäº¤
          git commit --allow-empty -m "ğŸ”€ chore: sync with upstream [${{ env.UPSTREAM_REPO }}@${{ env.UPSTREAM_BRANCH }}] - already up to date"
          git push origin ${{ env.TARGET_BRANCH }}
          echo "âœ… å·²åˆ›å»ºåŒæ­¥æ ‡è®°"

      - name: âš ï¸ Handle Merge Conflicts
        if: steps.merge.outputs.merge_status == 'conflict'
        run: |
          echo "âŒ åˆå¹¶å†²çªæ£€æµ‹ï¼"
          echo "================================"
          echo "æ— æ³•è‡ªåŠ¨åŒæ­¥ï¼Œå­˜åœ¨åˆå¹¶å†²çª"
          echo "è¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š"
          echo ""
          echo "git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git"
          echo "git fetch upstream"
          echo "git merge upstream/${{ env.UPSTREAM_BRANCH }}"
          echo "# è§£å†³å†²çªå"
          echo "git add ."
          echo "git commit -m 'Merge upstream changes'"
          echo "git push origin main"
          echo "================================"

      - name: ğŸ“‹ Sync Summary
        if: always()
        run: |
          echo "================================"
          echo "ğŸ”„ åŒæ­¥ä»»åŠ¡æ€»ç»“"
          echo "================================"
          echo "ğŸ“… æ‰§è¡Œæ—¶é—´: $(date)"
          echo "ğŸ  å½“å‰ä»“åº“: ${{ github.repository }}"
          echo "â¬†ï¸ ä¸Šæ¸¸ä»“åº“: ${{ env.UPSTREAM_REPO }}"
          echo "ğŸ¯ ç›®æ ‡åˆ†æ”¯: ${{ env.TARGET_BRANCH }}"
          echo "ğŸ”§ ä¸Šæ¸¸è®¿é—®: ${{ steps.verify.outputs.accessible }}"
          echo "ğŸ“¦ éœ€è¦åŒæ­¥: ${{ steps.check.outputs.needs_sync }}"
          echo "ğŸ”„ åˆå¹¶çŠ¶æ€: ${{ steps.merge.outputs.merge_status }}"
          
          if [ "${{ steps.verify.outputs.accessible }}" = "true" ]; then
            if [ "${{ steps.check.outputs.needs_sync }}" = "true" ]; then
              case "${{ steps.merge.outputs.merge_status }}" in
                "success")
                  echo "âœ… åŒæ­¥æˆåŠŸï¼æ›´æ”¹å·²æ¨é€"
                  ;;
                "no_changes")
                  echo "â„¹ï¸ å·²åŒæ­¥æ ‡è®°ï¼šå®é™…ä¸Šå·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬"
                  ;;
                "conflict")
                  echo "âš ï¸ åŒæ­¥å¤±è´¥ï¼šå­˜åœ¨åˆå¹¶å†²çª"
                  ;;
                *)
                  echo "âŒ åŒæ­¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯"
                  ;;
              esac
            else
              echo "â„¹ï¸ æ— éœ€åŒæ­¥ï¼šå·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬"
            fi
          else
            echo "âŒ åŒæ­¥å¤±è´¥ï¼šæ— æ³•è®¿é—®ä¸Šæ¸¸ä»“åº“"
          fi
