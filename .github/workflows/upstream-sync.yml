name: ğŸ”„ Sync with kinai9661/Flux-AI-Pro

permissions:
  contents: write

on:
  schedule:
    - cron: "0 5 * * *" # æ¯å¤© UTC æ—¶é—´ 05:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 13:00ï¼‰
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

env:
  UPSTREAM_REPO: kinai9661/Flux-AI-Pro
  UPSTREAM_BRANCH: main
  TARGET_BRANCH: main

jobs:
  sync-upstream:
    name: ğŸ”„ Sync from kinai9661/Flux-AI-Pro
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›ï¸ Checkout Current Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ› ï¸ Configure Git Identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ” Verify Upstream Access
        id: verify
        run: |
          echo "éªŒè¯ä¸Šæ¸¸ä»“åº“è®¿é—®: ${{ env.UPSTREAM_REPO }}"
          
          # æµ‹è¯•ä¸Šæ¸¸ä»“åº“æ˜¯å¦å¯ä»¥è®¿é—®
          if git ls-remote "https://github.com/${{ env.UPSTREAM_REPO }}.git" HEAD &>/dev/null; then
            echo "âœ… ä¸Šæ¸¸ä»“åº“å¯è®¿é—®: https://github.com/${{ env.UPSTREAM_REPO }}"
            echo "accessible=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ— æ³•è®¿é—®ä¸Šæ¸¸ä»“åº“"
            echo "accessible=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸ“¡ Setup Upstream Remote
        if: steps.verify.outputs.accessible == 'true'
        run: |
          # ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ä¸Šæ¸¸é…ç½®
          git remote remove upstream 2>/dev/null || true
          
          # æ·»åŠ ä¸Šæ¸¸ä»“åº“
          git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git"
          echo "âœ… å·²æ·»åŠ ä¸Šæ¸¸è¿œç¨‹: upstream -> https://github.com/${{ env.UPSTREAM_REPO }}.git"

      - name: ğŸ”„ Fetch Upstream Changes
        if: steps.verify.outputs.accessible == 'true'
        run: |
          echo "è·å–ä¸Šæ¸¸ä»“åº“çš„æ›´æ–°..."
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}
          
          echo "=== ä¸Šæ¸¸ä»“åº“æœ€æ–°æäº¤ ==="
          git log -1 --oneline upstream/${{ env.UPSTREAM_BRANCH }}
          
          echo "=== å½“å‰ä»“åº“æœ€æ–°æäº¤ ==="
          git log -1 --oneline HEAD

      - name: ğŸ“Š Compare Changes
        if: steps.verify.outputs.accessible == 'true'
        id: compare
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æäº¤éœ€è¦åŒæ­¥
          if git merge-base --is-ancestor HEAD upstream/${{ env.UPSTREAM_BRANCH }}; then
            echo "âœ… å½“å‰åˆ†æ”¯å·²ç»åŒ…å«æ‰€æœ‰ä¸Šæ¸¸æ›´æ”¹"
            echo "has_new_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ æ£€æµ‹åˆ°ä¸Šæ¸¸æœ‰æ–°æäº¤éœ€è¦åŒæ­¥"
            echo "has_new_changes=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºå°†è¦åŒæ­¥çš„æäº¤
            echo "=== å°†è¦åŒæ­¥çš„æäº¤ ==="
            git log --oneline HEAD..upstream/${{ env.UPSTREAM_BRANCH }}
          fi

      - name: ğŸ”€ Merge Upstream Changes
        if: steps.verify.outputs.accessible == 'true' && steps.compare.outputs.has_new_changes == 'true'
        id: merge
        run: |
          echo "å¼€å§‹åˆå¹¶ä¸Šæ¸¸æ›´æ”¹..."
          
          # å°è¯•è‡ªåŠ¨åˆå¹¶
          if git merge --no-commit --no-ff upstream/${{ env.UPSTREAM_BRANCH }}; then
            echo "âœ… è‡ªåŠ¨åˆå¹¶æˆåŠŸ"
            echo "merge_status=success" >> $GITHUB_OUTPUT
          else
            # æ£€æŸ¥æ˜¯å¦æœ‰å†²çª
            if git diff --check; then
              echo "âš ï¸ æ£€æµ‹åˆ°åˆå¹¶å†²çª"
              echo "merge_status=conflict" >> $GITHUB_OUTPUT
            else
              echo "âŒ åˆå¹¶è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯"
              echo "merge_status=error" >> $GITHUB_OUTPUT
            fi
            git merge --abort
          fi

      - name: âœ… Push Successful Merge
        if: steps.merge.outputs.merge_status == 'success'
        run: |
          git commit -m "ğŸ”€ chore: auto-sync with upstream [${{ env.UPSTREAM_REPO }}@${{ env.UPSTREAM_BRANCH }}]"
          git push origin ${{ env.TARGET_BRANCH }}
          echo "âœ… åŒæ­¥å®Œæˆï¼æ›´æ”¹å·²æ¨é€åˆ°ä»“åº“"

      - name: âš ï¸ Handle Merge Conflicts
        if: steps.merge.outputs.merge_status == 'conflict'
        run: |
          echo "âŒ åˆå¹¶å†²çªæ£€æµ‹ï¼"
          echo "================================"
          echo "æ— æ³•è‡ªåŠ¨åŒæ­¥ï¼Œå­˜åœ¨åˆå¹¶å†²çª"
          echo "è¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š"
          echo "1. åœ¨æœ¬åœ°æ‰§è¡Œ: git pull upstream main"
          echo "2. è§£å†³æ‰€æœ‰å†²çª"
          echo "3. æäº¤å¹¶æ¨é€åˆ°ä½ çš„ä»“åº“"
          echo "================================"
          
          # æ˜¾ç¤ºå†²çªæ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
          git status | grep -i "unmerged" || echo "æ— æ³•è·å–å†²çªæ–‡ä»¶åˆ—è¡¨"

      - name: ğŸ“‹ Sync Summary
        if: always()
        run: |
          echo "================================"
          echo "ğŸ”„ åŒæ­¥ä»»åŠ¡æ€»ç»“"
          echo "================================"
          echo "ğŸ“… æ‰§è¡Œæ—¶é—´: $(date)"
          echo "ğŸ  å½“å‰ä»“åº“: ${{ github.repository }}"
          echo "â¬†ï¸ ä¸Šæ¸¸ä»“åº“: ${{ env.UPSTREAM_REPO }}"
          echo "ğŸ¯ ç›®æ ‡åˆ†æ”¯: ${{ env.TARGET_BRANCH }}"
          echo "ğŸ”§ ä¸Šæ¸¸è®¿é—®: ${{ steps.verify.outputs.accessible }}"
          echo "ğŸ“¦ æœ‰æ–°æ›´æ”¹: ${{ steps.compare.outputs.has_new_changes }}"
          echo "ğŸ”„ åˆå¹¶çŠ¶æ€: ${{ steps.merge.outputs.merge_status }}"
          
          if [ "${{ steps.verify.outputs.accessible }}" = "true" ]; then
            if [ "${{ steps.compare.outputs.has_new_changes }}" = "true" ]; then
              if [ "${{ steps.merge.outputs.merge_status }}" = "success" ]; then
                echo "âœ… åŒæ­¥æˆåŠŸï¼"
              elif [ "${{ steps.merge.outputs.merge_status }}" = "conflict" ]; then
                echo "âš ï¸ åŒæ­¥å¤±è´¥ï¼šå­˜åœ¨åˆå¹¶å†²çª"
              else
                echo "âŒ åŒæ­¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯"
              fi
            else
              echo "â„¹ï¸ æ— éœ€åŒæ­¥ï¼šå·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬"
            fi
          else
            echo "âŒ åŒæ­¥å¤±è´¥ï¼šæ— æ³•è®¿é—®ä¸Šæ¸¸ä»“åº“"
          fi
